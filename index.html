<!DOCTYPE html>
<!-- vim: set noet: -->
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Kutuzov</title>
	<script>
		if (
			!window.File ||
			!window.FileReader ||
			!window.Blob
		) {
			alert('Your browser incompatible with Kutuzov. No luck.');
		}
	</script>
	<link rel="stylesheet" href="ktz.css" type="text/css" media="screen" charset="utf-8"/>
</head>
<body>
	<input id="file" name="file" type="file" />

	<label for="settings-wpm">words per minute</label>
	<input id="settings-wpm" name="wpm" type="text" value="500" size="4" maxlength="4" />

	<label for="settings-align">text align</label>
	<select id="settings-align" name="align">
		<option value="center">center</option>
		<option value="left">left</option>
		<option value="right">right</option>
	</select>

	<label for="settings-chunk-size">chunk size</label>
	<input id="settings-chunk-size" name="chunkSize" type="text" value="1" size="1" maxlength="1" />

	<label for="settings-font-size">font size</label>
	<input id="settings-font-size" name="fontSize" type="text" value="24" size="3" maxlength="3" />

	<div id="output"></div>
	<div id="controls">
		<button id="play">&gt; play</button>
		<button id="pause">|| pause</button>
	</div>

	<script>
		document.getElementById('file').addEventListener('change', handleFileSelect, false);
		document.getElementById('play').addEventListener('click', handlePlayClick, false);
		document.getElementById('pause').addEventListener('click', handlePauseClick, false);

		document.body.addEventListener('keypress', handleKeyPress, false);

		document.getElementById('settings-wpm').addEventListener('change', handleSettingsChange, false);
		document.getElementById('settings-align').addEventListener('change', handleSettingsChange, false);
		document.getElementById('settings-chunk-size').addEventListener('change', handleSettingsChange, false);
		document.getElementById('settings-font-size').addEventListener('change', handleSettingsChange, false);

		init();

		// initializes application at startup
		function init() {
			var config = new ktzConfig();
			applySettings(true)

			if(config.get('text')) {
				var container = document.getElementById('output');
				var iterator = new ktzIterator(config.get('text').split(/\s+/), 0);
				var drawer = new ktzDrawer(iterator, container);

				drawer();
			}

			switchMode(config.get('mode'));
		}

		// when settings changed
		function handleSettingsChange(ev) {
			var config = new ktzConfig();
			config.set('wpm', parseInt(document.getElementById('settings-wpm').value));
			config.set('align', document.getElementById('settings-align').value);
			config.set('fontSize', parseInt(document.getElementById('settings-font-size').value));
			config.set('chunkSize', parseInt(document.getElementById('settings-chunk-size').value));

			applySettings(true);
		}

		// read settings from config and apply it to player
		function applySettings(updateInputs) {
			var config = new ktzConfig();

			// apply wpm: restart required if in play mode
			if (config.get('mode') == 'play') {
				switchMode('pause');
				switchMode('play');
			}

			// apply style settings (font size and text align)
			document.getElementById('output').style.textAlign = config.get('align');
			document.getElementById('output').style.fontSize = config.get('fontSize').toString() + "px";

			// set appropriate inputs values
			if (updateInputs) {
				document.getElementById('settings-wpm').value = config.get('wpm');
				document.getElementById('settings-font-size').value = config.get('fontSize');
				document.getElementById('settings-chunk-size').value = config.get('chunkSize');
				
				for (var i = 0; i < document.getElementById('settings-align').options.length; i++) {
					var opt = document.getElementById('settings-align').options[i];
					opt.selected = (opt.value == config.get('align'));
				}
			}
		}

		// when user presses keyboard key
		function handleKeyPress(ev) {
			var config = new ktzConfig();

			switch (ev.keyCode) {
				// space: play/pause
				case 32:
					if (config.get('mode') == 'play') {
						switchMode('pause');
					} else if (config.get('mode') == 'pause') {
						switchMode('play');
					}

					break;
			}
		}

		// when user selects file
		function handleFileSelect(ev) {
			var config = new ktzConfig();
			var file = ev.target.files[0]

			if (!file) {
				return;
			}

			if (file.type != 'text/plain') {
				alert('Kutuzov can\'t see anything except old plain text files.');
				return;
			}

			config.set('pos', 0);

			var reader = new FileReader();
			reader.onloadend = function(ev) { handleFileLoad(ev, reader) };
			reader.readAsText(file);
		}

		// when file load ends
		function handleFileLoad(ev, reader) {
			var config = new ktzConfig();
			// @fixme do not store all the contents in localStorage
			config.set('text', reader.result);
			switchMode('play');
		}

		// play loaded text file
		function play() {
			var config = new ktzConfig();
			var container = document.getElementById('output');
			var iterator = new ktzIterator(config.get('text').split(/\s+/), 0);
			var drawer = new ktzDrawer(iterator, container);

			var interval = setInterval(function () {
					if (!drawer()) {
						clearInterval(config.get('interval'));
						switchMode('select');
					}
			}, 60 / config.get('wpm') * 1000);

			config.set('interval', interval);
		}

		// when user clicks play button
		function handlePlayClick(ev) {
			switchMode('play');
		}

		// when user clicks pause button
		function handlePauseClick(ev) {
			switchMode('pause');
		}

		// switch between modes (play, pause, select file etc)
		function switchMode(mode) {
			var config = new ktzConfig();

			switch(mode) {
				case 'play':
					document.getElementById('controls').style.display = 'block';
					document.getElementById('play').style.display = 'none';
					document.getElementById('pause').style.display = 'block';
					play();
					config.set('mode', 'play');
					break;
				case 'pause':
					document.getElementById('controls').style.display = 'block';
					document.getElementById('play').style.display = 'block';
					document.getElementById('pause').style.display = 'none';
					clearInterval(config.get('interval'));
					config.set('mode', 'pause');
					break;
				case 'select':
					document.getElementById('controls').style.display = 'none';
					config.set('mode', 'select');
					break;
			}
		}

		// handles persistent settings
		function ktzConfig() {
			// play speed in words per minute
			this.wpm = 500;

			// text align inside container
			this.align = 'center';

			// font size
			this.fontSize = 24;

			// chunk size (how many words to be displayed in one frame)
			this.chunkSize = 1;

			// get variable from application config
			this.get = function(key) {
				if(
					supportsLocalStorage() &&
					localStorage[key] !== undefined
				) {
					return localStorage[key];
				} else {
					return this[key];
				}
			}

			// store variable in localStorage
			this.set = function(key, val) {
				if (!supportsLocalStorage) {
					return false;
				}

				localStorage[key] = val;
			}

			// delete variable from localStorage
			this.unset = function(key) {
				if (!supportsLocalStorage) {
					return false;
				}

				localStorage.removeItem(key);
			}
		}

		// checks if browser has localStorage support
		function supportsLocalStorage() {
			try {
				return 'localStorage' in window && window['localStorage'] !== null;
			} catch (e) {
				return false;
			}
		}

		// loops through loaded text and gets the next chunk
		function ktzIterator(arr) {
			this.arr = arr;
			this.len = arr.length;
			this.config = new ktzConfig();

			if (this.config.get('pos')== undefined) {
				this.config.set('pos', 0);
				this.config.unset('text');
			}

			this.next = function() {
				if (this.config.get('pos') >= this.len) {
					this.config.set('pos', 0);
					this.config.unset('text');
					return false;
				}

				var newPos = parseInt(this.config.get('pos')) + parseInt(this.config.get('chunkSize'));
				var result = this.arr.slice(
					this.config.get('pos'),
					newPos
				).join(' ');

				this.config.set('pos', newPos);

				return result;
			}
		}

		// fills output container with current chunk of data
		function ktzDrawer(iterator, container) {
			return function () {
				word = iterator.next();

				if (word == false) {
					return false;
				}

				container.textContent = word;

				return true;
			}
		}
	</script>
</body>
</html>
